name: Android Release (GitHub Runner)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.2

      - name: Get version tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Prebuild Android
        run: npx expo prebuild --platform android --no-interactive

      - name: Setup Android Keystore
        id: keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          echo "Setting up keystore..."
          
          # Check if secrets are available
          if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "Using provided keystore from secrets..."
            echo $ANDROID_KEYSTORE_BASE64 | base64 -d > android/app/release.keystore
            echo "KEY_ALIAS=$ANDROID_KEY_ALIAS" >> $GITHUB_ENV
            echo "KEY_PASSWORD=$ANDROID_KEY_PASSWORD" >> $GITHUB_ENV
            echo "STORE_PASSWORD=$ANDROID_STORE_PASSWORD" >> $GITHUB_ENV
          else
            echo "No keystore secrets found. Generating a temporary debug keystore for release build..."
            # Generate a temporary keystore
            keytool -genkey -v -keystore android/app/release.keystore -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US"
            echo "KEY_ALIAS=androiddebugkey" >> $GITHUB_ENV
            echo "KEY_PASSWORD=android" >> $GITHUB_ENV
            echo "STORE_PASSWORD=android" >> $GITHUB_ENV
          fi
          
          echo "Keystore setup complete."

      - name: Build Android Release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/app/release.keystore \
            -Pandroid.injected.signing.store.password=${{ env.STORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ env.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ env.KEY_PASSWORD }}

      - name: Rename APK
        run: |
          # Find the APK (name might vary)
          APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" | head -n 1)
          echo "Found APK at: $APK_PATH"
          mv "$APK_PATH" CherryStudio.${{ steps.version.outputs.tag }}.apk

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: CherryStudio.${{ steps.version.outputs.tag }}.apk

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: CherryStudio.${{ steps.version.outputs.tag }}.apk
          draft: true
          prerelease: false
          name: Cherry Studio ${{ steps.version.outputs.tag }}
          body: |
            ## Cherry Studio ${{ steps.version.outputs.tag }} - Android
            
            ### ü§ñ Android
            - **Built on**: GitHub Actions (Ubuntu Runner)
            - **Type**: Release APK
            
            ‚ö†Ô∏è **Note**: If you did not configure a custom keystore in GitHub Secrets, this APK is signed with a temporary debug key. To update an existing installation, you may need to uninstall the old version first.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
